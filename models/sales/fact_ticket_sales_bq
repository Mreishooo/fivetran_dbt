USE [DWH]
GO

delete from [SE].[fact_ticket_sales_bq]
where  DimBookingDateId  >= ( select  CONVERT(varchar(20),   DATEADD(day, -31,CONVERT(date,CONVERT(varchar(8),max(DimBookingDateId)), 112))
  , 112)  FROM [dbo].[FactTicketSales] )

set identity_insert [SE].[fact_ticket_sales_bq] on 

INSERT INTO [SE].[fact_ticket_sales_bq]
           ([FactTicketSalesId]
		   ,[DimPerformanceDateId]
           ,[DimCountryId]
           ,[DimProductionId]
           ,[DimAuditoriumId]
           ,[DimProductionLocationId]
           ,[DimGoldenCustomerId]
           ,[DimCustomerId]
           ,[DimTheatreId]
           ,[DimReservationDateId]
           ,[DimBookingDateId]
           ,[DimCancellationDateId]
           ,[DimSeatId]
           ,[DimSourceId]
           ,[DimFileId]
           ,[DimArticleTypeId]
           ,[DimPerformanceTimeId]
           ,[DimBookingTimeId]
           ,[DimLeadDayRelationsPerformanceId]
           ,[BarCode]
           ,[SubOrderNumber]
           ,[WebOrderNumber]
           ,[TicketPrice]
           ,[SourceProduction]
           ,[SourceLocation]
           ,[SourcePriceCategoryId]
           ,[DimDistributionId]
           ,[TransactionType]
           ,[CancellationStatus]
           ,[SourcePromotionId]
           ,[SourcePromotionName]
           ,[SourcePriceTypeId]
           ,[SourcePriceTypeName]
           ,[SourceReferer]
           ,[SourceDistributionPointId]
           ,[SourceDistributionPoint]
           ,[DimLeadDayRelationsPremiereId]
           ,[DimPerformanceId]
           ,[ArticleCount]
           ,[SourceSeat]
           ,[SourceSeatRow]
           ,[SourceSeatNumber]
           ,[SourceCountryCode]
           ,[SourceCode]
           ,[SourceDistributionChannel]
           ,[IsTicketFree]
           ,[FreeTicketReason]
           ,[DimPriceCategoryId]
           ,[DimPriceTypeId]
           ,[CustomerPriceOld]
           ,[PaidPrice]
           ,[NetPriceOld]
           ,[NetNetPriceOld]
           ,[InitialStandardPrice]
           ,[InitialPrice]
           ,[ReferencePrice]
           ,[FullPrice]
           ,[FullPriceReduction]
           ,[ReferencePriceReduction]
           ,[EURInitialStandardPrice]
           ,[EURInitialPrice]
           ,[EURReferencePrice]
           ,[EURFullPrice]
           ,[EURTicketPrice]
           ,[EURCustomerPriceOld]
           ,[EURNetPriceOld]
           ,[EURPaidPrice]
           ,[EURNetNetPriceOld]
           ,[EURFullPriceReduction]
           ,[EURReferencePriceReduction]
           ,[MainOrderNumber]
           ,[PerformanceYearProdLoc]
           ,[PerformanceFiscalYearProdLoc]
           ,[BookingYearProdLoc]
           ,[BookingFiscalYearProdLoc]
           ,[LeadDaysPerformanceMonthGT180]
           ,[KickbackPercentage]
           ,[CommissionPercentage]
           ,[Distributionid]
           ,[VatPercentage]
           ,[PaidPricePreCommission]
           ,[SourceCampaignCode]
           ,[SourceCustomerId]
           ,[SourceClientId]
           ,[SourceSubClientId]
           ,[SourceCustomerCode]
           ,[LeadDaysPerformanceMonthGT120]
           ,[DimSalesPromotionId]
           ,[DimZipCodeId]
           ,[InsertDate]
           ,[DimDrivingDistanceId]
           ,[DimDrivingDurationId]
           ,[OutsideCommissions]
           ,[InsideCommissions]
           ,[CustomerFaceValue]
           ,[GBORNet]
           ,[Deductions]
           ,[NBOR]
           ,[EUROutsideCommissions]
           ,[EURInsideCommissions]
           ,[EURCustomerFaceValue]
           ,[EURGBORNet]
           ,[EURDeductions]
           ,[EURNBOR]
           ,[InsideCommissionsPreESSystemFee]
           ,[PaidPriceOld]
           ,[TicketPriceOld]
           ,[FullPriceReductionOld]
           ,[ReferencePriceReductionOld]
           ,[EURPaidPriceOld]
           ,[EURTicketPriceOld]
           ,[EURFullPriceReductionOld]
           ,[EURReferencePriceReductionOld]
           ,[PaidPricePreCommissionOld]
           ,[InsideCommissionsResellers]
           ,[InsideCommissionsCTS]
           ,[InsideCommissionsCTSSystemFee]
           ,[VAT]
           ,[FiscalTax]
           ,[Kickbacks]
           ,[Turnover]
           ,[EURInsideCommissionsResellers]
           ,[EURInsideCommissionsCTS]
           ,[EURInsideCommissionsCTSSystemFee]
           ,[EURVAT]
           ,[EURFiscalTax]
           ,[EURKickbacks]
           ,[EURTurnover]
           ,[DimOriginalBookingDateId]
           ,[DimGoldenCustomerAgeAtBookingId]
           ,[GoldenCustomerDaysSinceLastBooking]
           ,[DiscountPercentage]
           ,[GoldenCustomerXOrder]
           ,[IsReturningGoldenCustomer]
           ,[IsReturningGoldenCustomer18Month]
           ,[ProdLocPerformanceYear]
           ,[ProdLocPerformanceFiscalYear]
           ,[ProdLocBookingYear]
           ,[ProdLocBookingFiscalYear]
           ,[IsManualTicketSalesInput]
           ,[CustomerFaceValue_Computed]
           ,[TicketPrice_Computed]
           ,[FiscalTax_Computed]
           ,[Kickbacks_Computed]
           ,[GborNet_Computed]
           ,[Nbor_Computed]
           ,[Turnover_Computed]
           ,[DimOriginalRelocatedPerformanceId]
           ,[DimInflowId]
           ,[SourcePromotionCode]
           ,[OutsideCommissionsSource]
           ,[SourceCancellationReason]
           ,[SourcePaymentStatusId]
           ,[SourcePrintStatusId]
           ,[SourceDeliveryMethod]
           ,[DeltaReservationBooking]
           ,[SourcePaymentMethod]
           ,[DimPaymentMethodId]
           ,[SourceAgencyId]
           ,[SourceDeviceType]
           ,[SourcePackageID]
           ,[SourceSalesPartner]
           ,[SourceSalesPartnerClass]
           ,[SourceSalesPartnerClassId]
           ,[SubClient]
           ,[SourceDistributionChannelName]
           ,[TicketsPerOrder]
           ,[DimLeadDayRelationsStartSalesId]
           ,[DimCommissionModelId]
           ,[Rebate]
           ,[NetCommission]
           ,[GrossCommission]
           ,[LastUpdateDate]
           ,[SourcePromotionAdvertisingPartnerId]
           ,[Rebooked]
           ,[Replacement]
           ,[ReplacementType]
           ,[SwitchToPromoterVoucher]
           ,[DimPromoterVoucherId])
     select 
           [FactTicketSalesId]
		   ,[DimPerformanceDateId]
           ,[DimCountryId]
           ,[DimProductionId]
           ,[DimAuditoriumId]
           ,[DimProductionLocationId]
           ,[DimGoldenCustomerId]
           ,[DimCustomerId]
           ,[DimTheatreId]
           ,[DimReservationDateId]
           ,[DimBookingDateId]
           ,[DimCancellationDateId]
           ,[DimSeatId]
           ,[DimSourceId]
           ,[DimFileId]
           ,[DimArticleTypeId]
           ,[DimPerformanceTimeId]
           ,[DimBookingTimeId]
           ,[DimLeadDayRelationsPerformanceId]
           ,[BarCode]
           ,[SubOrderNumber]
           ,[WebOrderNumber]
           ,[TicketPrice]
           ,[SourceProduction]
           ,[SourceLocation]
           ,[SourcePriceCategoryId]
           ,[DimDistributionId]
           ,[TransactionType]
           ,[CancellationStatus]
           ,[SourcePromotionId]
           ,[SourcePromotionName]
           ,[SourcePriceTypeId]
           ,[SourcePriceTypeName]
           ,[SourceReferer]
           ,[SourceDistributionPointId]
           ,[SourceDistributionPoint]
           ,[DimLeadDayRelationsPremiereId]
           ,[DimPerformanceId]
           ,[ArticleCount]
           ,[SourceSeat]
           ,[SourceSeatRow]
           ,[SourceSeatNumber]
           ,[SourceCountryCode]
           ,[SourceCode]
           ,[SourceDistributionChannel]
           ,[IsTicketFree]
           ,[FreeTicketReason]
           ,[DimPriceCategoryId]
           ,[DimPriceTypeId]
           ,[CustomerPriceOld]
           ,[PaidPrice]
           ,[NetPriceOld]
           ,[NetNetPriceOld]
           ,[InitialStandardPrice]
           ,[InitialPrice]
           ,[ReferencePrice]
           ,[FullPrice]
           ,[FullPriceReduction]
           ,[ReferencePriceReduction]
           ,[EURInitialStandardPrice]
           ,[EURInitialPrice]
           ,[EURReferencePrice]
           ,[EURFullPrice]
           ,[EURTicketPrice]
           ,[EURCustomerPriceOld]
           ,[EURNetPriceOld]
           ,[EURPaidPrice]
           ,[EURNetNetPriceOld]
           ,[EURFullPriceReduction]
           ,[EURReferencePriceReduction]
           ,[MainOrderNumber]
           ,[PerformanceYearProdLoc]
           ,[PerformanceFiscalYearProdLoc]
           ,[BookingYearProdLoc]
           ,[BookingFiscalYearProdLoc]
           ,[LeadDaysPerformanceMonthGT180]
           ,[KickbackPercentage]
           ,[CommissionPercentage]
           ,[Distributionid]
           ,[VatPercentage]
           ,[PaidPricePreCommission]
           ,[SourceCampaignCode]
           ,[SourceCustomerId]
           ,[SourceClientId]
           ,[SourceSubClientId]
           ,[SourceCustomerCode]
           ,[LeadDaysPerformanceMonthGT120]
           ,[DimSalesPromotionId]
           ,[DimZipCodeId]
           ,[InsertDate]
           ,[DimDrivingDistanceId]
           ,[DimDrivingDurationId]
           ,[OutsideCommissions]
           ,[InsideCommissions]
           ,[CustomerFaceValue]
           ,[GBORNet]
           ,[Deductions]
           ,[NBOR]
           ,[EUROutsideCommissions]
           ,[EURInsideCommissions]
           ,[EURCustomerFaceValue]
           ,[EURGBORNet]
           ,[EURDeductions]
           ,[EURNBOR]
           ,[InsideCommissionsPreESSystemFee]
           ,[PaidPriceOld]
           ,[TicketPriceOld]
           ,[FullPriceReductionOld]
           ,[ReferencePriceReductionOld]
           ,[EURPaidPriceOld]
           ,[EURTicketPriceOld]
           ,[EURFullPriceReductionOld]
           ,[EURReferencePriceReductionOld]
           ,[PaidPricePreCommissionOld]
           ,[InsideCommissionsResellers]
           ,[InsideCommissionsCTS]
           ,[InsideCommissionsCTSSystemFee]
           ,[VAT]
           ,[FiscalTax]
           ,[Kickbacks]
           ,[Turnover]
           ,[EURInsideCommissionsResellers]
           ,[EURInsideCommissionsCTS]
           ,[EURInsideCommissionsCTSSystemFee]
           ,[EURVAT]
           ,[EURFiscalTax]
           ,[EURKickbacks]
           ,[EURTurnover]
           ,[DimOriginalBookingDateId]
           ,[DimGoldenCustomerAgeAtBookingId]
           ,[GoldenCustomerDaysSinceLastBooking]
           ,[DiscountPercentage]
           ,[GoldenCustomerXOrder]
           ,[IsReturningGoldenCustomer]
           ,[IsReturningGoldenCustomer18Month]
           ,[ProdLocPerformanceYear]
           ,[ProdLocPerformanceFiscalYear]
           ,[ProdLocBookingYear]
           ,[ProdLocBookingFiscalYear]
           ,[IsManualTicketSalesInput]
           ,[CustomerFaceValue_Computed]
           ,[TicketPrice_Computed]
           ,[FiscalTax_Computed]
           ,[Kickbacks_Computed]
           ,[GborNet_Computed]
           ,[Nbor_Computed]
           ,[Turnover_Computed]
           ,[DimOriginalRelocatedPerformanceId]
           ,[DimInflowId]
           ,[SourcePromotionCode]
           ,[OutsideCommissionsSource]
           ,[SourceCancellationReason]
           ,[SourcePaymentStatusId]
           ,[SourcePrintStatusId]
           ,[SourceDeliveryMethod]
           ,[DeltaReservationBooking]
           ,[SourcePaymentMethod]
           ,[DimPaymentMethodId]
           ,[SourceAgencyId]
           ,[SourceDeviceType]
           ,[SourcePackageID]
           ,[SourceSalesPartner]
           ,[SourceSalesPartnerClass]
           ,[SourceSalesPartnerClassId]
           ,[SubClient]
           ,[SourceDistributionChannelName]
           ,[TicketsPerOrder]
           ,[DimLeadDayRelationsStartSalesId]
           ,[DimCommissionModelId]
           ,[Rebate]
           ,[NetCommission]
           ,[GrossCommission]
           ,[LastUpdateDate]
           ,[SourcePromotionAdvertisingPartnerId]
           ,[Rebooked]
           ,[Replacement]
           ,[ReplacementType]
           ,[SwitchToPromoterVoucher]
           ,[DimPromoterVoucherId]
		FROM dbo.FactTicketSales
where  DimBookingDateId  >= ( select  CONVERT(varchar(20),   DATEADD(day, -31 ,CONVERT(date,CONVERT(varchar(8),max(DimBookingDateId)), 112))
  , 112)  FROM [dbo].[FactTicketSales] )
 
GO


